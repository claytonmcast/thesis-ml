<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Model Training</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-data/dist/tf-data.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgpu"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm/dist/tf-backend-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        button:disabled {
            background-color: #d3d3d3;
            color: #777;
            cursor: not-allowed;
        }

        /* Processing button style */
        button.processing {
            position: relative;
        }

        button.processing::after {
            content: "";
            width: 12px;
            height: 12px;
            border: 2px solid #777;
            border-top-color: transparent;
            border-radius: 50%;
            position: absolute;
            right: -16px;
            top: 50%;
            transform: translateY(-50%);
            animation: spin 1s linear infinite;
        }

        button.processing .process-number {
            display: block;
            width: 12px;
            height: 12px;
            border-top-color: transparent;
            position: absolute;
            right: -14px;
            top: 50%;
            text-align: center;
        }

        .process-number {
            display: none;
        }

        @keyframes spin {
            0% {
                transform: translateY(-50%) rotate(0deg);
            }

            100% {
                transform: translateY(-50%) rotate(360deg);
            }
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: #1e293b;
            /* Dark blue-gray */
            margin: 20px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            display: inline-block;
            padding-bottom: 10px;
            width: 100%;
        }

        .title.text-sm{
            font-size: .875rem;
            line-height: 1.25rem;
        }

        .title::after {
            content: "";
            width: 60px;
            height: 4px;
            background: #4f46e5;
            /* Nice blue accent */
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-semibold mb-6 text-center">Train ML Datasets in Browser</h1>
        <div class="flex gap-4">
            <div class="w-1/2 overflow-auto">
                <table class="min-w-full table-auto bg-white border border-gray-300 rounded-lg shadow-lg">
                    <thead class="bg-blue-500 text-white">
                        <tr>
                            <th class="py-2 px-2 text-center">Model</th>
                            <th class="py-2 px-2 text-center" colspan="3">Dataset Size</th>
                        </tr>
                        <tr>
                            <th class="py-2 px-2"></th>
                            <th class="py-2 px-2 text-center"></th>
                            <th class="py-2 px-2 text-center"></th>
                            <th class="py-2 px-2 text-center"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4">
                                <h1 class="title">Linear Regression</h1>
                            </td>
                        </tr>
                        <!-- Model Row 1 -->
                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">TensorFlow.js CPU</td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="10%"
                                    dataset="house_price/sample_10%.csv"
                                    class="lr-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 10%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="50%"
                                    dataset="house_price/sample_50%.csv"
                                    class="lr-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 50%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="100%"
                                    dataset="house_price/sample_100%.csv"
                                    class="lr-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 100%)<span
                                        class="process-number"></span></button></td>
                        </tr>
                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">TensorFlow.js WebGPU</td>
                            <td class="py-4 px-2 text-center"><button engine="webgpu" sample="10%"
                                    dataset="house_price/sample_10%.csv"
                                    class="lr-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 10%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="webgpu" sample="50%"
                                    dataset="house_price/sample_50%.csv"
                                    class="lr-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 50%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="webgpu" sample="100%"
                                    dataset="house_price/sample_100%.csv"
                                    class="lr-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 100%)<span
                                        class="process-number"></span></button></td>
                        </tr>
                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">TensorFlow.js WASM</td>
                            <td class="py-4 px-2 text-center"><button engine="wasm" sample="10%"
                                    dataset="house_price/sample_10%.csv"
                                    class="lr-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 10%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="wasm" sample="50%"
                                    dataset="house_price/sample_50%.csv"
                                    class="lr-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 50%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="wasm" sample="100%"
                                    dataset="house_price/sample_100%.csv"
                                    class="lr-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 100%)<span
                                        class="process-number"></span></button></td>
                        </tr>
                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">Rust WASM CPU</td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="10%"
                                    dataset="house_price/sample_10%.csv"
                                    class="lr-wasm bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 10%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="50%"
                                    dataset="house_price/sample_50%.csv"
                                    class="lr-wasm bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 50%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="100%"
                                    dataset="house_price/sample_100%.csv"
                                    class="lr-wasm bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 100%)<span
                                        class="process-number"></span></button></td>
                        </tr>
                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">Python GPU</td>
                            <td class="py-4 px-2 text-center"><button engine="gpu" sample="10%" dataset="1"
                                    class="lr-python bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 10%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="gpu" sample="50%" dataset="2"
                                    class="lr-python bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 50%)<span
                                        class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="gpu" sample="100%" dataset="3"
                                    class="lr-python bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample 100%)<span
                                        class="process-number"></span></button></td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <h1 class="title">Neural Network</h1>
                            </td>
                        </tr>
                        <!-- Model Row 2 -->
                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">TensorFlow.js CPU</td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="10%" dataset="0.10"
                                    class="mnist-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    10%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="50%" dataset="0.50"
                                    class="mnist-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    50%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="100%" dataset="1.0"
                                    class="mnist-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    100%)<span class="process-number"></span></button></span></td>
                        </tr>

                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">TensorFlow.js WebGPU</td>
                            <td class="py-4 px-2 text-center"><button engine="webgpu" sample="10%" dataset="0.10"
                                    class="mnist-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    10%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="webgpu" sample="50%" dataset="0.50"
                                    class="mnist-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    50%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="webgpu" sample="100%" dataset="1.0"
                                    class="mnist-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    100%)<span class="process-number"></span></button></td>
                        </tr>

                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">TensorFlow.js WASM</td>
                            <td class="py-4 px-2 text-center"><button engine="wasm" sample="10%" dataset="0.10"
                                    class="mnist-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    10%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="wasm" sample="50%" dataset="0.50"
                                    class="mnist-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    50%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="wasm" sample="100%" dataset="1.0"
                                    class="mnist-tf bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    100%)<span class="process-number"></span></button></td>
                        </tr>

                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">Rust WASM CPU</td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="10%" dataset="0.10"
                                    class="mnist-wasm bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    10%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="50%" dataset="0.50"
                                    class="mnist-wasm bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    50%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="cpu" sample="100%" dataset="1.0"
                                    class="mnist-wasm bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    100%)<span class="process-number"></span></button></td>
                        </tr>

                        <tr class="border-t border-gray-200">
                            <td class="py-4 px-2">Python GPU</td>
                            <td class="py-4 px-2 text-center"><button engine="gpu" sample="10%" dataset="1"
                                    class="mnist-python bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    10%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="gpu" sample="50%" dataset="2"
                                    class="mnist-python bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    50%)<span class="process-number"></span></button></td>
                            <td class="py-4 px-2 text-center"><button engine="gpu" sample="100%" dataset="3"
                                    class="mnist-python bg-blue-500 text-white py-2 px-2 rounded-lg">Run (sample
                                    100%)<span class="process-number"></span></button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="w-1/2 bg-gray-50 p-4 border border-gray-200">
                <h2 class="text-lg font-semibold mb-2">Operations</h2>
                <div class="p-4">
                    <label for="tries" class="block text-sm font-medium text-gray-700 mb-1">
                        Tries
                    </label>
                    <input type="number" id="tries" name="tries" min="1"
                        class="w-32 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="1" value="15" />
                    <button type="button"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" id="run-all">
                        Run All
                    </button>
                </div>
                <div id="result-grid-component" class="p-4" x-data="bindResultListTable()" x-init="init()" :class="{ 'initialized': initialized }">
                    <!-- <button id="refresh-result-grid-component" style="display: none;" @click="init()"></button> -->
                    <button id="refresh-result-grid-component" style="display: none;"></button>
                    <table class="min-w-full divide-y divide-gray-200 bg-white rounded-lg shadow">
                        <thead class="bg-gray-100">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Id</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tries</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Start</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    End</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                </th>
                            </tr>
                        </thead>
                        <template x-for="(item, index) in data" :key="index">
                            <tbody class="divide-y divide-gray-200">
                                <tr :class="index % 2 === 0 ? 'bg-gray-50 hover:bg-gray-100' : ''">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-html="item.id"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-html="item.tries">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"><span
                                            x-text="item.start ? dayjs(item.start).format('DD/MM/YYYY HH:mm:ss') : '-'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"><span
                                            x-text="item.end ? dayjs(item.end).format('DD/MM/YYYY HH:mm:ss') : '-'"></span>
                                    </td>
                                    <td>
                                        <button title="experiments" @click="displayExperiments(item)"
                                            :class="(item.display_experiments == true) ? 'bg-gray-500 text-white py-2 px-2 rounded-sm' : 'bg-blue-500 text-white py-2 px-2 rounded-sm'"><i
                                                class="fa-solid fa-flask"></i></button>
                                        <button title="metrics" @click="displayMetrics(item)"
                                            :class="(item.show_metric == true) ? 'bg-gray-500 text-white py-2 px-2 rounded-sm' : 'bg-blue-500 text-white py-2 px-2 rounded-sm'">
                                            <i class="fa-solid fa-table"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr x-show="item.show_metric">
                                    <td colspan="5">
                                        <h1  x-show="item.show_metric_lr" class="title text-sm">Linear Regression Confidence Interval</h1>
                                        <table x-show="item.show_metric_lr" class="min-w-full divide-y divide-gray-200 bg-white rounded-lg shadow">
                                            <thead class="bg-blue-200">
                                                <tr>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Platform</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Dataset</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Training Time</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Inference Time</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        MSE</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        R2
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200">
                                                <template x-if="item.lr_confidence_interval"  x-for="(platform, ci_idx) in Object.keys(item.lr_confidence_interval??{})" :key="ci_idx">
                                                    <template x-for="(dataset, ds_idx) in Object.keys(item.lr_confidence_interval[platform])" :key="ds_idx">
                                                        <tr
                                                            :class="ds_idx % 2 === 0 ? 'bg-blue-50 hover:bg-blue-100' : ''">
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700"
                                                                x-html="platform"></td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700"
                                                                x-html="dataset"></td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700">
                                                                <div x-html="item.lr_confidence_interval[platform][dataset].training_time.ci_lower"></div>
                                                                <div x-html="item.lr_confidence_interval[platform][dataset].training_time.ci_upper"></div>
                                                            </td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700">
                                                                <div x-html="item.lr_confidence_interval[platform][dataset].inference_time.ci_lower"></div>
                                                                <div x-html="item.lr_confidence_interval[platform][dataset].inference_time.ci_upper"></div>
                                                            </td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700"> 
                                                                <div x-html="item.lr_confidence_interval[platform][dataset].mse.ci_lower"></div>
                                                                <div x-html="item.lr_confidence_interval[platform][dataset].mse.ci_upper"></div>
                                                            </td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700"> 
                                                                <div x-html="item.lr_confidence_interval[platform][dataset].r2.ci_lower"></div>
                                                                <div x-html="item.lr_confidence_interval[platform][dataset].r2.ci_upper"></div>
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </template>
                                            </tbody>
                                        </table> 
                                        <h1 x-show="item.show_metric_nn" class="title text-sm">Neural Network Confidence Interval</h1>
                                        <table x-show="item.show_metric_nn" class="min-w-full divide-y divide-gray-200 bg-white rounded-lg shadow">
                                            <thead class="bg-blue-200">
                                                <tr>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Platform</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Dataset</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Training Time</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Inference Time</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Accuracy</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Loss
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200">
                                                <template x-if="item.nn_confidence_interval" x-for="(platform, ci_idx) in Object.keys(item.nn_confidence_interval??{})" :key="ci_idx">
                                                    <template x-for="(dataset, ds_idx) in Object.keys(item.nn_confidence_interval[platform])" :key="ds_idx">
                                                        <tr
                                                            :class="ds_idx % 2 === 0 ? 'bg-blue-50 hover:bg-blue-100' : ''">
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700"
                                                                x-html="platform"></td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700"
                                                                x-html="dataset"></td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700">
                                                                <div x-html="item.nn_confidence_interval[platform][dataset].training_time.ci_lower"></div>
                                                                <div x-html="item.nn_confidence_interval[platform][dataset].training_time.ci_upper"></div>
                                                            </td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700">
                                                                <div x-html="item.nn_confidence_interval[platform][dataset].inference_time.ci_lower"></div>
                                                                <div x-html="item.nn_confidence_interval[platform][dataset].inference_time.ci_upper"></div>
                                                            </td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700"> 
                                                                <div x-html="item.nn_confidence_interval[platform][dataset].accuracy.ci_lower"></div>
                                                                <div x-html="item.nn_confidence_interval[platform][dataset].accuracy.ci_upper"></div>
                                                            </td>
                                                            <td class="px-1 py-4 whitespace-nowrap text-xs text-gray-700"> 
                                                                <div x-html="item.nn_confidence_interval[platform][dataset].loss.ci_lower"></div>
                                                                <div x-html="item.nn_confidence_interval[platform][dataset].loss.ci_upper"></div>
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </template>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr x-show="item.display_experiments">
                                    <td colspan="5">
                                        <table class="min-w-full divide-y divide-gray-200 bg-white rounded-lg shadow">
                                            <thead class="bg-blue-200">
                                                <tr>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Type</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Try</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Sample</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Start</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        End</th>
                                                    <th
                                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    </th>
                                                    <th>

                                                    </th>
                                                </tr>
                                            </thead>
                                            <template x-for="(group) in item.experiments" :key="group.try">
                                                <template x-for="(exp, exindex) in group.experiments" :key="exindex">
                                                    <tbody class="divide-y divide-gray-200"> 
                                                        <tr x-show="exindex == 0">
                                                            <td colspan="6"
                                                                class="bg-gray-100 text-center px-4 py-2 text-sm text-gray-700 font-medium border-b">
                                                                <span x-text="group.try"></span>
                                                                <button
                                                                    :title="exp.type.indexOf('L') == 0 ? 'linear regression' : 'neural network'"
                                                                    @click="group.show_graphs = !group.show_graphs"
                                                                    :class="(group.show_graphs == true) ? 'bg-gray-500 text-white py-2 px-2 rounded-sm' : 'bg-blue-500 text-white py-2 px-2 rounded-sm'">
                                                                    <i class="fa-solid fa-chart-line"></i>
                                                            </td>
                                                        </tr>
                                                        <template x-if="exindex == 0 && group.show_graphs == true">
                                                            <tr x-show="exindex == 0 && group.show_graphs == true">
                                                                <td colspan="6">
                                                                    <div x-show="group.experiments[0].type.indexOf('L') == 0">
                                                                        <h2 class="title">Linear Regression</h2>
                                                                        <h3 class="title text-sm">Training Time VS Dataset Size</h3>
                                                                        <img :src="exp.try_path + '/training_time_comparison.png'" />
                                                                        <h3 class="title text-sm">Inference Time VS Dataset Size</h3>
                                                                        <img :src="exp.try_path + '/inference_time_comparison.png'" />
                                                                        <h3 class="title text-sm" x-html="exp.type.indexOf('L') == 0 ? 'MSE VS Dataset Size': 'Accuracy VS Dataset Size'"></h3>
                                                                        <img :src="exp.try_path + (exp.type.indexOf('L') == 0 ? '/mse_comparison.png': '/accuracy_comparison.png' ) " />
                                                                        <h3 class="title text-sm" x-html="exp.type.indexOf('L') == 0 ? 'R2 VS Dataset Size': 'Loss VS Dataset Size'"></h3>
                                                                        <img :src="exp.try_path + (exp.type.indexOf('L') == 0 ? '/r2_comparison.png': '/loss_comparison.png' )" />
                                                                    </div>
                                                                    <div x-show="group.experiments[group.experiments.length -1 ].type.indexOf('N') == 0">
                                                                        <h2 class="title">Neural Network</h2>
                                                                        <h3 class="title text-sm">Training Time VS Dataset Size</h3>
                                                                        <img :src="exp.try_path + '/training_time_comparison.png'" />
                                                                        <h3 class="title text-sm">Inference Time VS Dataset Size</h3>
                                                                        <img :src="exp.try_path + '/inference_time_comparison.png'" />
                                                                        <h3 class="title text-sm" x-html="exp.type.indexOf('L') == 0 ? 'MSE VS Dataset Size': 'Accuracy VS Dataset Size'"></h3>
                                                                        <img :src="exp.try_path + (exp.type.indexOf('L') == 0 ? '/mse_comparison.png': '/accuracy_comparison.png' ) " />
                                                                        <h3 class="title text-sm" x-html="exp.type.indexOf('L') == 0 ? 'R2 VS Dataset Size': 'Loss VS Dataset Size'"></h3>
                                                                        <img :src="exp.try_path + (exp.type.indexOf('L') == 0 ? '/r2_comparison.png': '/loss_comparison.png' )" />
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                        <tr
                                                            :class="exindex % 2 === 0 ? 'bg-blue-50 hover:bg-blue-100' : ''">
                                                            <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700"
                                                                x-html="exp.type"></td>
                                                            <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700"
                                                                x-html="exp.try"></td>
                                                            <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700"
                                                                x-html="exp.sample"></td>
                                                            <td
                                                                class="px-2 py-4 whitespace-nowrap text-sm text-gray-700">
                                                                <div x-text="dayjs(exp.start).format('DD/MM/YYYY')">
                                                                </div>
                                                                <div x-text="dayjs(exp.start).format('HH:mm:ss')">
                                                                </div>
                                                            </td>
                                                            <td
                                                                class="px-2 py-4 whitespace-nowrap text-sm text-gray-700">
                                                                <div x-text="dayjs(exp.end).format('DD/MM/YYYY')">
                                                                </div>
                                                                <div x-text="dayjs(exp.end).format('HH:mm:ss')"></div>
                                                            </td>
                                                            <td>
                                                                <button
                                                                    :title="exp.type.indexOf('L') == 0 ? 'linear regression' : 'neural network'"
                                                                    @click="exp.show_experiment_graph = !exp.show_experiment_graph"
                                                                    :class="(exp.show_experiment_graph == true) ? 'bg-gray-500 text-white py-2 px-2 rounded-sm' : 'bg-blue-500 text-white py-2 px-2 rounded-sm'">
                                                                    <i class="fa-solid fa-chart-line"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <template x-if="exp.show_experiment_graph == true">
                                                            <tr x-show="exp.show_experiment_graph == true">
                                                                <td colspan="6">
                                                                    <div x-show="exp.type.indexOf('L') == 0">
                                                                        <h3 class="title text-sm">Regression Line</h3>
                                                                        <img
                                                                            :src="exp.experiment_path + '/' + exp.platform + `_sample_${exp.sample}_regression_line.png`" />
                                                                        <h3 class="title text-sm">Loss History</h3>
                                                                        <img
                                                                            :src="exp.experiment_path + '/' + exp.platform + `_sample_${exp.sample}_loss_history.png`" />
                                                                    </div>
                                                                    <div x-show="exp.type.indexOf('N') == 0">
                                                                        <h3 class="title text-sm">Accuracy</h3>
                                                                        <img
                                                                            :src="exp.experiment_path + '/' + exp.platform + `_sample_${exp.sample}_accuracy.png`" />
                                                                            <h3 class="title text-sm">Loss</h3>
                                                                        <img
                                                                            :src="exp.experiment_path + '/' + exp.platform + `_sample_${exp.sample}_loss.png`" />
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                </template>
                                            </template>
                                        </table>
                                    </td>
                                </tr>
                            </tbody>
                        </template>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <script>
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        var currentResultItem = null;
        var executionTries = 1;
        var runAllProcessing = false;


        async function startProcessing(el, process, position) { 

            var tries = Number(document.getElementById("tries").value);
            var pinExecutionTries = executionTries;
            for (let i = pinExecutionTries; i < tries; i++) {
                executionTries = i + 1;
                el.querySelector('.process-number').innerHTML = (tries + 1 - executionTries);

                // await sleep(1000); // Wait for 1 second (1000 ms) to release resources
                await process();
                await sleep(1000);
               // location.href = 'blank.html';
            }
            executionTries = 0;
            var end = new Date();
            if (runAllProcessing != true) {
                await updateResultItem({ 
                    end,
                    result_item_id: currentResultItem.id
                });
            }
        }

        async function plotLinearRegression() {
            var tries = Number(document.getElementById("tries").value);
            const response = await fetch("/api/plot_linear_regression?id=" + currentResultItem.id + "&tries=" + tries);
            const data = await response.json();
            return data;
        }

        async function plotNeuralNetwork() {
            var tries = Number(document.getElementById("tries").value);
            const response = await fetch("/api/plot_neural_network?id=" + currentResultItem.id + "&tries=" + tries);
            const data = await response.json();
            return data;
        }


        async function getResultList() {
            const response = await fetch("/result_list.json");
            const data = await response.json();
            return data;
        }

        async function getConfidenceInterval(location) {
            const response = await fetch(location);
            const data = await response.json();
            return data;
        }

        async function getNewResultItem(is_run_all) {
            var tries = Number(document.getElementById("tries").value);
            const response = await fetch("/api/new_result_item?tries=" + tries + "&isRunAll=" + (is_run_all == true) + "&start=" + (new Date()).toISOString());
            const data = await response.json();
            ///
            currentResultItem = data; 
            document.querySelector('#refresh-result-grid-component').click();
            ///
            return data;
        }

        async function updateResultItem(resultItem) {

            const response = await fetch("/api/update_result_item", {
                method: "POST", // Specifies the request method
                headers: {
                    "Content-Type": "application/json" // Tells the server that the request body is JSON
                },
                body: JSON.stringify(resultItem) // Convert the data object to a JSON string
            });

            // Parse the response as JSON
            const responseData = await response.json();
            document.querySelector('#refresh-result-grid-component').click()
            return responseData;
        }


        async function appendExperiment(experiment) {

            const response = await fetch("/api/append_experiment", {
                method: "POST", // Specifies the request method
                headers: {
                    "Content-Type": "application/json" // Tells the server that the request body is JSON
                },
                body: JSON.stringify(experiment) // Convert the data object to a JSON string
            });

            // Parse the response as JSON
            const responseData = await response.json();
            document.querySelector('#refresh-result-grid-component').click()
            return responseData;
        }

        function startProcess(el) {
            disable_enable_buttons(true);
            el.classList.add("processing");
        }

        function stopProcess(el) {
            disable_enable_buttons(false);
            el.classList.remove("processing");
            document.querySelector('#refresh-result-grid-component').click()
        }
        function disable_enable_buttons(isDisabled) {
            document.querySelectorAll('button').forEach(element => {
                element.disabled = isDisabled;
                if (isDisabled == false) {
                    element.classList.remove("processing");
                }
            });
            document.getElementById('tries').disabled = isDisabled;
        }

    </script>


    <script type="module" src="/linear_regression/app/tensorflow_js/tensorflow_js_app.js"></script>
    <script type="module" src="/linear_regression/app/rust_wasm/src/rust_wasm_app.js"></script>
    <script type="module" src="/neural_network/app/tensorflow_js/tensorflow_js_app.js"></script>
    <script type="module" src="/neural_network/app/rust_wasm/src/rust-wasm-app.js"></script>

    <script type="module">
        import handleLinearRegression from '/linear_regression/app/tensorflow_js/tensorflow_js_app.js'
        import handleLinearRegressionRustWasm from '/linear_regression/app/rust_wasm/src/rust_wasm_app.js'
        import handleNeuralNetwork from '/neural_network/app/tensorflow_js/tensorflow_js_app.js';
        import handleNeuralNetworkRustWasm from '/neural_network/app/rust_wasm/src/rust-wasm-app.js';

        document.addEventListener('DOMContentLoaded', (event) => {
            var el = document.getElementById('run-all');
            el.addEventListener("click", async () => {
                await runAll();
            });
        });

        async function runAll(lastExecutedExperiment) {
            if(runAllProcessing == true){
                return;
            }
            runAllProcessing = true;
            const tries = Number(document.getElementById("tries").value);
            const totalButtons = 30;
            
            const totalExecutions = totalButtons * tries;

            if (lastExecutedExperiment === undefined) {
                await getNewResultItem(true);
                lastExecutedExperiment = 0;
            } 

            if (lastExecutedExperiment >= totalExecutions) {
                console.log("All done!");
                const end = new Date();
                await updateResultItem({
                    end: end,
                    result_item_id: currentResultItem.id
                });
                await plotLinearRegression();
                await plotNeuralNetwork();
                runAllProcessing = false;
                return;
            }
 
            const buttonIndex = Math.floor(lastExecutedExperiment / tries); 

            // Collect all button elements in the same order as your totalButtons count (30)
            const allButtons = [
                ...document.querySelectorAll("button.lr-tf"),
                ...document.querySelectorAll("button.lr-wasm"),
                ...document.querySelectorAll("button.lr-python"),
                ...document.querySelectorAll("button.mnist-tf"),
                ...document.querySelectorAll("button.mnist-wasm"),
                ...document.querySelectorAll("button.mnist-python")
            ];

            // Safeguard check
            if (buttonIndex >= allButtons.length) {
                console.error("Index out of range: nextIndex is too large.");
                return;
            }

            const executionIndexForThisButton = lastExecutedExperiment % tries;
            executionTries = executionIndexForThisButton;
             
            try {
                // Call appropriate handler based on button class
                for (let i = buttonIndex; i < allButtons.length; i++) {
                    const button = allButtons[i];
                    const executionIndexForThisButton = i; // update if needed differently

                    if (button.classList.contains("lr-tf")) {
                        await handleLinearRegression(button, executionIndexForThisButton);
                    } else if (button.classList.contains("lr-wasm")) {
                        await handleLinearRegressionRustWasm(button, executionIndexForThisButton);
                    } else if (button.classList.contains("lr-python")) {
                        await handleLinearRegressionPython(button, executionIndexForThisButton);
                    } else if (button.classList.contains("mnist-tf")) {
                        await handleNeuralNetwork(button, executionIndexForThisButton);
                    } else if (button.classList.contains("mnist-wasm")) {
                        await handleNeuralNetworkRustWasm(button, executionIndexForThisButton);
                    } else if (button.classList.contains("mnist-python")) {
                        await handleNeuralNetworkPython(button, executionIndexForThisButton);
                    }
                }
            }catch(ex){
                 location.href = 'blank.html?dt=' + new Date();
            }

            runAllProcessing = false;
        }
        window.runAll = runAll;

        async function runPython(type, dataset, sample) {
            var tries = Number(document.getElementById("tries").value);
            const response = await fetch(`/api/run_python?type=${type}&try=${executionTries}&sample=${sample}&dataset=${dataset}&result_item_id=${currentResultItem.id}`);
            const data = await response.json();
        }

        async function handleLinearRegressionPython(el, position) {
            var dataset = el.getAttribute('dataset');
            var engine = el.getAttribute('engine');
            var sample = el.getAttribute('sample');

            startProcess(el);
            if (runAllProcessing != true) {
                await getNewResultItem();
            }
            await startProcessing(el, async () => await runPython("Linear Regression Python GPU", dataset, sample), position);
            if (runAllProcessing != true) {
                await plotLinearRegression();
            }
            stopProcess(el);
        }

        async function handleNeuralNetworkPython(el, position) {
            var dataset = el.getAttribute('dataset');
            var engine = el.getAttribute('engine');
            var sample = el.getAttribute('sample');

            startProcess(el);
            if (runAllProcessing != true) {
                await getNewResultItem();
            }
            await startProcessing(el, async () => await runPython("Neural Network Python GPU", dataset, sample));
            if (runAllProcessing != true) {
                await plotNeuralNetwork();
            }
            stopProcess(el);
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            Array.from(document.querySelectorAll("button.lr-python")).forEach(el => {
                el.addEventListener("click", async () => {
                    await handleLinearRegressionPython(el)
                });
            });
            Array.from(document.querySelectorAll("button.mnist-python")).forEach(el => {
                el.addEventListener("click", async () => {
                    await handleNeuralNetworkPython(el);
                });
            });
        });


    </script>

    
<script>
    var resultGridComponent = {};
    function bindResultListTable() {
        resultGridComponent = {
            data: [],
            initialized: false,
            async init() {
                if (this.initialized) return; // Prevent re-running init if already initialized
                this.initialized = true;  // Mark as initialized
                const resultList = await getResultList();
                if(resultList.length > 0){ 
                    var resultItem = resultList[resultList.length -1];
                    var isRunAll = resultItem.isRunAll == 'true';
                    
                    if(resultItem.end == undefined){
                        // needs to continue
                        document.getElementById("tries").value = resultItem.tries;
                        currentResultItem = resultItem;
                        var experiments = resultItem.experiments;
                        if(isRunAll == true){
                            var funcRun = false;
                            do 
                            {
                                if (typeof window.runAll === "function") { 
                                    window.runAll(experiments.length);
                                    funcRun = true;
                                }
                                await sleep(1000);
                            }while(funcRun == false)
                            
                        }
                    }
                }
                resultList.forEach(result => {
                    // Group experiments by 'try'
                    const groupedExperiments = result.experiments.reduce((acc, exp) => {
                        const key = exp.try;
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(exp);
                        return acc;
                    }, {});

                    // Convert grouped experiments to a sorted array
                    result.experiments = Object.entries(groupedExperiments)
                        .map(([tryNumber, experiments]) => ({
                            try: Number(tryNumber),
                            experiments: experiments.sort((a,b)=>Number(a.sample.replace('%', '')) - Number(b.sample.replace('%', '')))
                        }))
                        .sort((a, b) => a.try - b.try)
                        .reverse();

                    result.confidence_interval = {};
                });

                this.data = resultList; 

                // this.data = resultList.map(item => ({
                //     ...item,
                //     display_experiments: false
                // }));
            },
            displayExperiments(operation) {
                operation.display_experiments = !operation.display_experiments;
                console.log(this.data);
            },
            async displayMetrics(operation) {
                operation.show_metric = !operation.show_metric;
                var firstExperiment = operation.experiments[0].experiments[0];
                var firstLocation = firstExperiment.location + '/confidence_interval_metric.json';
                
                if(firstExperiment.type.indexOf('L') == 0){
                    var ci = await getConfidenceInterval(firstLocation);
                    operation.show_metric_lr = true;
                    operation.lr_confidence_interval = ci;
                }
                if(firstExperiment.type.indexOf('N') == 0){
                    var ci = await getConfidenceInterval(firstLocation);
                    operation.show_metric_nn = true;
                    operation.nn_confidence_interval = ci;
                }

                var lastExperiment = operation.experiments[operation.experiments.length -1].experiments[0];
                var lastLocation = firstExperiment.location + '/confidence_interval_metric.json'; 
                if(firstExperiment.type.indexOf('L') != lastExperiment.type.indexOf('L')){
                    var ci = await getConfidenceInterval(lastLocation);
                    operation.show_metric_nn = true;
                    operation.nn_confidence_interval = ci;
                }
            }
        };
        return resultGridComponent;
    }

</script>


    <!-- <script type="module" src="/large-language-model/app//tensorflow_js/tensorflow_js_app.js"></script> -->

    <!--
    <script type="module" src="/transformer/assets/t-app.js"></script> -->


</body>

</html>